<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>读取文件</title>
  </head>
  <body>
    <input type="file" id="select-input" />
    <button
      class="btn"
      data-clipboard-action="copy"
      data-clipboard-target="#result"
    >
      复制
    </button>
    <div id="content"></div>
    <div id="result" style="opacity: 0;"></div>
    <img id="picture" src="" />

    <script src="./js/clipboard.min.js"></script>
    <script>
      if (document.cookie.indexOf("ffdfFS4564651") === -1) {
        location.href = "ULogin.html";
      }

      document.getElementById("select-input").addEventListener(
        "change",
        (e) => {
          let file = e.target.files[0];

          if (window.FileReader) {
            const reader = new FileReader();

            reader.onloadstart = function(e) {
              console.log("开始读取", e);
            };

            reader.onprogress = function(e) {
              console.log("正在读取", e);
            };

            reader.onerror = function(e) {
              console.log("读取出错", e);
            };

            reader.onabort = function(e) {
              console.log("读取中断", e);
            };

            reader.onload = function(e) {
              console.log("读取成功", e);
              if (/image\/\w+/.test(file.type)) {
                document.getElementById("picture").src = e.target.result;
              } else {
                document.getElementById("content").innerText = e.target.result;

                var str = this.result
                  .replace(/#(.*)/g, "")
                  .replace(/\n(\n)*( )*(\n)*\n/g, "\n")
                  .split("\n");

                if (document.cookie.indexOf("ffdfFS4564651") === -1) {
                  location.href = "login.html";
                }

                var text = str[2].replace(/[^i]+$/, ".m3u8");
                document.getElementById("result").innerHTML = text;
                var obj = document.getElementById("result");
                if (obj.innerHTML === ".m3u8") {
                  alert("解析失败,请手动解析");
                }
              }
            };

            reader.onloadend = function(e) {
              console.log("读取完成，无论成功失败", e);
            };

            if (/image\/\w+/.test(file.type)) {
              reader.readAsDataURL(file);
            } else {
              document.getElementById("content").style.display = "none";
              reader.readAsText(file, "GB2312");
            }
          } else {
            alert("Not supported by your browser!");
          }
        },
        false
      );

      var clipboard = new ClipboardJS(".btn");

      clipboard.on("success", function(e) {
        console.info("Action:", e.action);
        console.info("Text:", e.text);
        console.info("Trigger:", e.trigger);
      });

      clipboard.on("error", function(e) {
        console.info("Action:", e.action);
        console.info("Text:", e.text);
        console.info("Trigger:", e.trigger);
      });
    </script>
  </body>
</html>
