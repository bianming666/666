<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./bootstrap/css/bootstrap.min.css" />
    <title>读取文件</title>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col-xs-6">
          <input type="file" id="select-input"
          <span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span>
          </input>
        </div>
        <div class="col-xs-6">
          <button id="Copy" class="btn_copy" data-clipboard-action="copy" data-clipboard-target="#result" data-container="body" data-toggle="popover" data-placement="bottom" data-content data-animation="true" data-trigger="manual">
            <span class="glyphicon glyphicon-duplicate" aria-hidden="true"></span>
            复制
          </button>
        </div>
      </div>
      <div id="content"></div>
      <div id="result" style="opacity: 0;"></div>

      <div>
        <img id="picture" src="" />
      </div>
    </div>

    <script src="./js/clipboard.min.js"></script>
    <script src="./js/squirrel.js"></script>
    <script src="./js/jquery.min.js"></script>
    <script src="./bootstrap/js/bootstrap.min.js"></script>
    <script>
      $(function () {
        $('[data-toggle="popover"]').popover();
      });
      let base = new Base64();
      let URL = base.decode("VUxvZ2luLmh0bWw=");
      let variable = $cookies.getCookies("isUser");
      if (document.cookie.indexOf(variable) === -1) {
        location.href = URL;
      }

      document.getElementById("select-input").addEventListener(
        "change",
        (e) => {
          let file = e.target.files[0];

          if (window.FileReader) {
            const reader = new FileReader();

            reader.onloadstart = function(e) {
              console.log("开始读取", e);
            };

            reader.onprogress = function(e) {
              console.log("正在读取", e);
            };

            reader.onerror = function(e) {
              console.log("读取出错", e);
            };

            reader.onabort = function(e) {
              console.log("读取中断", e);
            };

            reader.onload = function(e) {
              console.log("读取成功", e);
              if (/image\/\w+/.test(file.type)) {
                document.getElementById("picture").src = e.target.result;
              } else {
                document.getElementById("content").innerText = e.target.result;

                var str = this.result
                  .replace(/#(.*)/g, "")
                  .replace(/\n(\n)*( )*(\n)*\n/g, "\n")
                  .split("\n");

                if (document.cookie.indexOf(variable) === -1) {
                  location.href = URL;
                }
                let resultPlus = str[2].split("com")

                var text = resultPlus[1].replace(/[^i]+$/, ".m3u8");
                document.getElementById("result").innerHTML = "https://p.hjcfcf.com" + text;
                var obj = document.getElementById("result");
                if (obj.innerHTML === ".m3u8") {
                  alert("解析失败,请手动解析");
                }
              }
            };

            reader.onloadend = function(e) {
              console.log("读取完成，无论成功失败", e);
            };

            if (/image\/\w+/.test(file.type)) {
              reader.readAsDataURL(file);
            } else {
              document.getElementById("content").style.display = "none";
              reader.readAsText(file, "GB2312");
            }
          } else {
            alert("Not supported by your browser!");
          }
        },
        false
      );

      var clipboard = new ClipboardJS(".btn");

      clipboard.on("success", function(e) {
        console.info("Action:", e.action);
        console.info("Text:", e.text);
        console.info("Trigger:", e.trigger);
        document.getElementById("Copy").dataset.content="复制成功 ！";
        $("#Copy").popover('show');
        setTimeout(function(){
            $('#Copy').popover('destroy')
          },1360);
      });

      clipboard.on("error", function(e) {
        console.info("Action:", e.action);
        console.info("Text:", e.text);
        console.info("Trigger:", e.trigger);
        document.getElementById("Copy").setAttribute("data-content","复制失败 ！");
         $("#Copy").popover('show');
          setTimeout(function(){
            $('#Copy').popover('destroy')
          },1360);
      });
    </script>
  </body>
</html>
